# Blockify Distillation Service - Docker Compose
#
# Usage:
#   docker-compose up -d          # Start service
#   docker-compose logs -f        # View logs
#   docker-compose down           # Stop service
#
# Environment variables can be set in .env file or passed directly

version: '3.8'

services:
  distillation:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: blockify-distillation-service:latest
    container_name: blockify-distill
    restart: unless-stopped
    ports:
      - "${PORT:-8315}:8315"
    volumes:
      - distill-data:/app/data
    environment:
      # Required API Keys (set these in .env or environment)
      - BLOCKIFY_API_KEY=${BLOCKIFY_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}

      # Server Configuration
      - HOST=0.0.0.0
      - PORT=8315
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Database Configuration
      - DATABASE_BACKEND=${DATABASE_BACKEND:-sqlite}
      - DATABASE_URL=${DATABASE_URL:-sqlite:///./data/jobs.db}
      - DATA_DIR=/app/data

      # Job Configuration
      - JOB_RETENTION_ENABLED=${JOB_RETENTION_ENABLED:-false}
      - JOB_RETENTION_DAYS=${JOB_RETENTION_DAYS:-30}
      - JOB_TIMEOUT_SECONDS=${JOB_TIMEOUT_SECONDS:-600000}
      - MAX_WORKERS=${MAX_WORKERS:-5}

      # Algorithm Configuration
      - MAX_CLUSTER_SIZE_FOR_LLM=${MAX_CLUSTER_SIZE_FOR_LLM:-20}
      - LLM_PARALLEL_THREADS=${LLM_PARALLEL_THREADS:-5}
      - USE_LSH=${USE_LSH:-true}

      # Observability
      - PROMETHEUS_ENABLED=${PROMETHEUS_ENABLED:-true}
      - OTLP_ENABLED=${OTLP_ENABLED:-false}
      - OTLP_ENDPOINT=${OTLP_ENDPOINT:-}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8315/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

  # Optional: PostgreSQL backend (uncomment to enable)
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: blockify-distill-db
  #   restart: unless-stopped
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #   environment:
  #     - POSTGRES_DB=blockify_distill
  #     - POSTGRES_USER=${POSTGRES_USER:-blockify}
  #     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U blockify"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # Optional: Redis backend (uncomment to enable)
  # redis:
  #   image: redis:7-alpine
  #   container_name: blockify-distill-redis
  #   restart: unless-stopped
  #   volumes:
  #     - redis-data:/data
  #   command: redis-server --appendonly yes
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # Optional: Prometheus (uncomment to enable monitoring stack)
  # prometheus:
  #   image: prom/prometheus:latest
  #   container_name: blockify-distill-prometheus
  #   restart: unless-stopped
  #   ports:
  #     - "9090:9090"
  #   volumes:
  #     - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
  #     - prometheus-data:/prometheus
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #     - '--storage.tsdb.path=/prometheus'

volumes:
  distill-data:
    driver: local
  # postgres-data:
  #   driver: local
  # redis-data:
  #   driver: local
  # prometheus-data:
  #   driver: local

networks:
  default:
    name: blockify-network
